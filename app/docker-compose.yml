# docker-compose.yml
# Template de Projeto Multiplataforma Docker Compose

networks:
  monorepo-internal:
    name: app_monorepo-internal
    external: true

services:

  monorepo-db:
    build:
      context: ./db
      dockerfile: Dockerfile
    image: "${APP_DB_IMAGE_NAME:-db}"
    container_name: "${APP_DB_CONTAINER_NAME:-db}"
    hostname: "${APP_DB_HOSTNAME:-db}"
    environment:
      POSTGRES_DB: "${APP_DB_NAME:-db}"
      POSTGRES_USER: "${APP_DB_USER:-postgres}"
      POSTGRES_PASSWORD: "${APP_DB_PASSWORD:-postgres}"
      PGTZ: "${APP_DB_TZ:-Etc/UTC}"
      LANG: "${APP_DB_LANG:-C.UTF-8}"
      LC_ALL: "${APP_DB_LC_ALL:-C.UTF-8}"
    ports:
      - "${APP_DB_PORT:-5432}:5432"
    volumes:
      - db-data:/var/lib/postgresql/data
      - ./db/init/migrations:/docker-entrypoint-initdb.d:ro
    command: ["postgres"]
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "pg_isready -U ${APP_DB_USER:-postgres} -d ${APP_DB_NAME:-db}",
        ]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 30s
    restart: unless-stopped
    networks:
      - monorepo-internal

  monorepo-api:
    build:
      context: ./api
      dockerfile: Dockerfile
    image: "${APP_API_IMAGE_NAME:-api}"
    container_name: "${APP_API_CONTAINER_NAME:-api}"
    hostname: "${APP_API_HOSTNAME:-api}"
    depends_on:
      monorepo-db:
        condition: service_healthy
    environment:
      NODE_ENV: "${APP_API_NODE_ENV:-development}"
      PORT: "${APP_API_PORT:-3001}"
      HOST: "${APP_API_HOST:-0.0.0.0}"
      CORS_ORIGIN: "${APP_API_CORS_ORIGIN:-*}"
      DATABASE_HOST: "${APP_DB_HOST:-db}"
      DATABASE_PORT: "5432"
      DATABASE_USER: "${APP_DB_USER:-postgres}"
      DATABASE_PASSWORD: "${APP_DB_PASSWORD:-postgres}"
      DATABASE_NAME: "${APP_DB_NAME:-db}"
      GOOGLE_MAPS_SERVER_KEY: "${GOOGLE_MAPS_SERVER_KEY:-}"
      GOOGLE_CLIENT_ID: "${APP_GOOGLE_CLIENT_ID:-}"
      GOOGLE_CLIENT_SECRET: "${APP_GOOGLE_CLIENT_SECRET:-}"
      JWT_SECRET: "${APP_JWT_SECRET:-}"
      JWT_EXPIRES_IN: "${APP_JWT_EXPIRES_IN:-24h}"
      GMAIL_CLIENT_ID: "${GMAIL_CLIENT_ID:-}"
      GMAIL_CLIENT_SECRET: "${GMAIL_CLIENT_SECRET:-}"
      GMAIL_REFRESH_TOKEN: "${GMAIL_REFRESH_TOKEN:-}"
      GMAIL_SENDER: "${GMAIL_SENDER:-noreply@cranio.dev}"
      APP_BASE_URL: "${APP_BASE_URL:-http://localhost:5174}"
      API_BASE_URL: "${APP_API_BASE_URL:-http://localhost:3001}"
      API_PRODUCTION_URL: "${APP_API_PRODUCTION_URL:-${APP_API_BASE_URL:-http://localhost:3001}}"
      OPENROUTER_API_KEY: "${OPENROUTER_API_KEY:-}"
      OPENROUTER_BASE_URL: "${OPENROUTER_BASE_URL:-https://openrouter.ai/api/v1/chat/completions}"
      OPENROUTER_MODEL: "${OPENROUTER_MODEL:-anthropic/claude-3.5-sonnet}"
      OPENROUTER_HTTP_REFERER: "${OPENROUTER_HTTP_REFERER:-}"
      OPENROUTER_APP_TITLE: "${OPENROUTER_APP_TITLE:-APP}"
      GOOGLE_MAPS_GEOCODING_API_URL: "${GOOGLE_MAPS_GEOCODING_API_URL:-https://maps.googleapis.com/maps/api/geocode/json}"
      APP_JOB_SERVICE_TOKEN: "${APP_JOB_SERVICE_TOKEN:-default-service-token}"
      API_HEALTHCHECK_URL: "${APP_API_HEALTHCHECK_URL:-http://localhost:3001/api/health}"
    ports:
      - "${APP_API_PORT:-3001}:3001"
    restart: unless-stopped
    networks:
      - monorepo-internal
    healthcheck:
      test: ["CMD", "sh", "-c", "response=$$(curl -sf $${API_HEALTHCHECK_URL:-http://localhost:3001/api/health}) && echo \"$$response\" | grep -q '\"status\":\"ok\"' && echo \"$$response\" | grep -q '\"database\":\"connected\"'"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  monorepo-oauth2:
    build:
      context: ./oauth2
      dockerfile: Dockerfile
    image: "${APP_OAUTH2_PROXY_IMAGE_NAME:-monorepo-oauth2}"
    container_name: "${APP_OAUTH2_PROXY_CONTAINER_NAME:-monorepo-oauth2}"
    hostname: "${APP_OAUTH2_PROXY_HOSTNAME:-monorepo-oauth2}"
    depends_on:
      monorepo-ui:
        condition: service_started
      monorepo-api:
        condition: service_started
    environment:
      OAUTH2_PROXY_PROVIDER: "google"
      OAUTH2_PROXY_CLIENT_ID: "${APP_OAUTH2_PROXY_CLIENT_ID:-${APP_GOOGLE_CLIENT_ID:-}}"
      OAUTH2_PROXY_CLIENT_SECRET: "${APP_OAUTH2_PROXY_CLIENT_SECRET:-${APP_GOOGLE_CLIENT_SECRET:-}}"
      OAUTH2_PROXY_COOKIE_SECRET: "${APP_OAUTH2_PROXY_COOKIE_SECRET:-}"
      OAUTH2_PROXY_REDIRECT_URL: "${APP_OAUTH2_PROXY_REDIRECT_URL:-https://monorepo.cranio.dev/oauth2/callback}"
      OAUTH2_PROXY_EMAIL_DOMAINS: "${APP_OAUTH2_PROXY_EMAIL_DOMAINS:-*}"
      OAUTH2_PROXY_UPSTREAM: "${APP_OAUTH2_PROXY_UPSTREAM:-http://monorepo-ui:80}"
      OAUTH2_PROXY_HTTP_ADDRESS: "${APP_OAUTH2_PROXY_HTTP_ADDRESS:-0.0.0.0:4180}"
      OAUTH2_PROXY_REVERSE_PROXY: "${APP_OAUTH2_PROXY_REVERSE_PROXY:-true}"
      OAUTH2_PROXY_SET_AUTHORIZATION_HEADER: "${APP_OAUTH2_PROXY_SET_AUTHORIZATION_HEADER:-true}"
      OAUTH2_PROXY_SKIP_PROVIDER_BUTTON: "${APP_OAUTH2_PROXY_SKIP_PROVIDER_BUTTON:-true}"
      OAUTH2_PROXY_SKIP_AUTH_ROUTE: "${APP_OAUTH2_PROXY_SKIP_AUTH_ROUTE:-GET=/assets/* GET=/icons/* GET=/manifest.webmanifest GET=/registerSW.js}"
      OAUTH2_PROXY_COOKIE_DOMAIN: "${APP_OAUTH2_PROXY_COOKIE_DOMAIN:-monorepo.cranio.dev}"
      OAUTH2_PROXY_COOKIE_SECURE: "${APP_OAUTH2_PROXY_COOKIE_SECURE:-true}"
      OAUTH2_PROXY_COOKIE_SAMESITE: "${APP_OAUTH2_PROXY_COOKIE_SAMESITE:-none}"
      OAUTH2_PROXY_COOKIE_CSRF_PER_REQUEST: "${APP_OAUTH2_PROXY_COOKIE_CSRF_PER_REQUEST:-false}"
      OAUTH2_PROXY_PASS_HOST_HEADER: "${APP_OAUTH2_PROXY_PASS_HOST_HEADER:-true}"
      OAUTH2_PROXY_PASS_USER_HEADERS: "${APP_OAUTH2_PROXY_PASS_USER_HEADERS:-true}"
      GODEBUG: "netdns=cgo"
    ports:
      - "${APP_OAUTH2_PROXY_PORT:-5180}:4180"
    dns:
      - 8.8.8.8
      - 8.8.4.4
      - 1.1.1.1
    dns_search: []
    dns_opt:
      - use-vc
      - no-tld-query
    restart: unless-stopped
    networks:
      - monorepo-internal
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:4180/ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

  monorepo-ui:
    build:
      context: ./ui
      dockerfile: Dockerfile
      args:
        # Variáveis VITE_* são necessárias apenas em build-time
        # Seguindo a cadeia: .env → docker-compose.yml → Dockerfile ARG
        VITE_GOOGLE_MAPS_API_KEY: "${GOOGLE_MAPS_API_KEY:-}"
        VITE_API_BASE_URL: "${APP_UI_VITE_API_BASE_URL:-http://localhost:3001}"
        VITE_GOOGLE_CLIENT_ID: "${APP_UI_VITE_GOOGLE_CLIENT_ID:-}"
    image: "${APP_UI_IMAGE_NAME:-ui}"
    container_name: "${APP_UI_IMAGE_NAME:-ui}"
    hostname: "${APP_UI_HOSTNAME:-ui}"
    depends_on:
      monorepo-api:
        condition: service_started
    environment:
      NODE_ENV: "${APP_UI_NODE_ENV:-production}"
      # Nota: Variáveis VITE_* não são necessárias em runtime (apenas build-time)
      # Elas são "embutidas" no bundle JavaScript durante o build
    ports:
      - "${APP_UI_PORT:-5174}:80"
    restart: unless-stopped
    networks:
      - monorepo-internal

  monorepo-job:
    build:
      context: ./job
      dockerfile: Dockerfile
    image: "${APP_JOB_IMAGE_NAME:-job}"
    container_name: "${APP_JOB_CONTAINER_NAME:-job}"
    hostname: "${APP_JOB_HOSTNAME:-job}"
    depends_on:
      monorepo-api:
        condition: service_started
    environment:
      NODE_ENV: "${APP_JOB_NODE_ENV:-development}"
      PORT: "${APP_JOB_PORT:-3002}"
      APP_JOB_INBOX: "${APP_JOB_INBOX:-/var/data/inbox}"
      APP_JOB_PROCESSED: "${APP_JOB_PROCESSED:-/var/data/processed}"
      APP_JOB_FAILED: "${APP_JOB_FAILED:-/var/data/failed}"
      APP_API_BASE_URL: "${APP_API_BASE_URL:-http://api:3001}"
      APP_API_TOKEN: "${APP_JOB_SERVICE_TOKEN:-default-service-token}"
      APP_JOB_POLL_INTERVAL: "${APP_JOB_POLL_INTERVAL:-60000}"
      APP_JOB_BATCH_SIZE: "${APP_JOB_BATCH_SIZE:-100}"
      APP_JOB_MAX_RETRIES: "${APP_JOB_MAX_RETRIES:-3}"
      LOG_LEVEL: "${APP_JOB_LOG_LEVEL:-info}"
    ports:
      - "${APP_JOB_PORT:-3002}:3002"
    volumes:
      - job-inbox:/var/data/inbox
      - job-processed:/var/data/processed
      - job-failed:/var/data/failed
    restart: unless-stopped
    networks:
      - monorepo-internal
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:3002/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  prettier:
    build:
      context: ..
      dockerfile: prettier/Dockerfile
    image: "${APP_PRETTIER_IMAGE_NAME:-prettier}"
    container_name: "${APP_PRETTIER_CONTAINER_NAME:-prettier}"
    volumes:
      - ..:/workspace:rw
    environment:
      IN_DOCKER: "${APP_PRETTIER_IN_DOCKER:-true}"
      WORK_DIR: "${APP_PRETTIER_WORK_DIR:-/workspace}"
    working_dir: /workspace
    entrypoint: ["/bin/bash", "/workspace/prettier/entrypoint.sh"]
    profiles:
      - tools
    # Não precisa de restart, healthcheck ou portas (serviço utilitário)

volumes:
  db-data:
  job-inbox:
  job-processed:
  job-failed:
