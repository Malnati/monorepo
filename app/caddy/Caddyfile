# app/caddy/Caddyfile
# Configuração do Caddy para HTTPS automático via Let's Encrypt
# Documentação: docs/rup/99-anexos/MVP/plano-deploy-google-sso.md

{
	# Configuração global
	email admin@dominio.com.br
	# HTTPS automático via Let's Encrypt está habilitado por padrão
}

# Redirecionamento HTTP para HTTPS (produção)
:80 {
	@production {
		host app.dominio.com.br
	}
	handle @production {
		redir https://app.dominio.com.br{uri} permanent
	}
	
	# Para desenvolvimento local, não redireciona
	handle {
		reverse_proxy ui:80
	}
}

# Configuração HTTPS (produção)
app.dominio.com.br {
	# HTTPS automático via Let's Encrypt (padrão do Caddy)
	# O Caddy automaticamente obtém e renova certificados SSL

	# Matchers para identificar arquivos estáticos
	@js {
		path *.js
	}
	@mjs {
		path *.mjs
	}
	@css {
		path *.css
	}
	@json {
		path *.json
	}
	@svg {
		path *.svg
	}

	# Proxy reverso para API (deve vir antes do handler genérico)
	handle /app/api* {
		reverse_proxy api:3001 {
			header_up Host {host}
			header_up X-Real-IP {remote}
			header_up X-Forwarded-For {remote}
			header_up X-Forwarded-Proto {scheme}
		}
	}

	# Proxy reverso para frontend (todos os outros requests, incluindo assets)
	handle {
		reverse_proxy ui:80 {
			header_up Host {host}
			header_up X-Real-IP {remote}
			header_up X-Forwarded-For {remote}
			header_up X-Forwarded-Proto {scheme}
		}
		# Sobrescrever Content-Type para arquivos estáticos
		header @js Content-Type application/javascript
		header @mjs Content-Type application/javascript
		header @css Content-Type text/css
		header @json Content-Type application/json
		header @svg Content-Type image/svg+xml
	}

	# Logs
	log {
		output stdout
		format console
	}
}

