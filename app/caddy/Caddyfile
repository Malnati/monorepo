# app/caddy/Caddyfile
# Configuração do Caddy para HTTPS automático via Let's Encrypt
# Documentação: docs/rup/99-anexos/MVP/plano-deploy-google-sso.md

{
	# Configuração global
	email admin@cranio.dev
	# HTTPS automático via Let's Encrypt está habilitado por padrão
}

# Redirecionamento HTTP para HTTPS (produção)
# Escutar especificamente no IPv6 2a02:c207:2288:9919::10
[2a02:c207:2288:9919::10]:80 {
	@production {
		host template-monorepo.cranio.dev
	}
	handle @production {
		redir https://template-monorepo.cranio.dev{uri} permanent
	}
	
	# Para desenvolvimento local, não redireciona
	handle {
		reverse_proxy localhost:5174
	}
}

# Configuração HTTPS (produção)
# Escutar especificamente no IPv6 2a02:c207:2288:9919::10
# Usar o domínio como label para permitir certificado SSL automático
template-monorepo.cranio.dev {
	# Escutar no IPv6 específico
	bind [2a02:c207:2288:9919::10]
	# HTTPS automático via Let's Encrypt (padrão do Caddy)
	# O Caddy automaticamente obtém e renova certificados SSL

	# Matchers para identificar arquivos estáticos
	@js {
		path *.js
	}
	@mjs {
		path *.mjs
	}
	@css {
		path *.css
	}
	@json {
		path *.json
	}
	@svg {
		path *.svg
	}

	# Proxy reverso para API (deve vir antes do handler genérico)
	handle /app/api* {
		reverse_proxy localhost:3001 {
			header_up Host {host}
			header_up X-Real-IP {remote}
			header_up X-Forwarded-For {remote}
			header_up X-Forwarded-Proto {scheme}
		}
	}

	# Proxy reverso para frontend (todos os outros requests, incluindo assets)
	handle {
		reverse_proxy localhost:5174 {
			header_up Host {host}
			header_up X-Real-IP {remote}
			header_up X-Forwarded-For {remote}
			header_up X-Forwarded-Proto {scheme}
		}
		# Sobrescrever Content-Type para arquivos estáticos
		header @js Content-Type application/javascript
		header @mjs Content-Type application/javascript
		header @css Content-Type text/css
		header @json Content-Type application/json
		header @svg Content-Type image/svg+xml
	}

	# Logs
	log {
		output stdout
		format console
	}
}
