name: Engineering Automação & Scripts Agent Check

on:
  push:
    branches:
      - main
      - staging
      - development

jobs:
  agent-engineering-automacao-scripts:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check relevant changed files
        run: |
          set -e
          
          # Obter arquivos alterados comparando com o commit anterior
          # Em eventos de push, github.event.before contém o SHA do commit anterior
          if [ -n "${{ github.event.before }}" ] && [ "${{ github.event.before }}" != "0000000000000000000000000000000000000000" ]; then
            files=$(git diff --name-only ${{ github.event.before }}..${{ github.sha }})
          elif git rev-parse --verify HEAD~1 >/dev/null 2>&1; then
            files=$(git diff --name-only HEAD~1..HEAD)
          else
            # Primeiro commit: lista apenas arquivos do commit atual
            files=$(git diff-tree --no-commit-id --name-only -r HEAD)
          fi
          
          found=0
          for file in $files; do
            if [[ "$file" =~ (^|/)docker-compose(\.ya?ml)?$ ]] || \
               [[ "$file" =~ (^|/)Dockerfile.*$ ]]     || \
               [[ "$file" == "package.json" ]]         || \
               [[ "$file" =~ \.sh$ ]]; then
              found=1
              echo "Arquivo relevante encontrado: $file"
              break
            fi
          done

          if [[ $found -eq 0 ]]; then
            echo "Nenhum arquivo relevante encontrado (docker, package.json ou *.sh). Interrompendo o workflow com sucesso."
            exit 78
          else
            echo "Arquivo relevante presente. Prosseguindo com workflow."
          fi

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: |
          npm ci || yarn install

      - name: Run Engineering Automação & Scripts Agent
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BRANCH_NAME: ${{ github.ref_name }}
          COMMIT_SHA: ${{ github.sha }}
        run: |
          # Script temporariamente desabilitado até implementação completa
          # node scripts/run-agent-engineering-automacao-scripts.js \
          #   --branch $BRANCH_NAME \
          #   --commit $COMMIT_SHA \
          #   --config .github/agents/agent-engineering-automacao-scripts.md
          echo "Step de execução do agente será implementado futuramente"
