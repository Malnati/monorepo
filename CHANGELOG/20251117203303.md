<!-- CHANGELOG/20251117203303.md -->
# Changelog - Atualização Backend e Testes para White Label

**Data/Hora UTC:** 2025-11-17 20:33:03

## Arquivos Modificados

### Backend API
- `app/api/src/constants/index.ts` - Adicionados novos códigos de erro `OWN_OFFER_PURCHASE` e `OFFER_ALREADY_SOLD`
- `app/api/src/modules/transacao/transacao.service.ts` - Atualizado para usar novos códigos de erro genéricos
- `app/api/src/modules/offer/offer.service.ts` - Atualizado queries SQL, mensagens de erro e comentários para terminologia genérica
- `app/api/src/modules/offer/offer.controller.spec.ts` - Atualizado testes para incluir novos campos `offersVendidos` e `offersComprados`

### Testes E2E
- `app/api/test/test-helpers.ts` - Adicionado `TEST_OFFERS` como alias genérico, atualizado nomes de produtos
- `app/api/test/lote-transacao-restrictions.e2e-spec.ts` - Refatorado completamente para usar `/offers` endpoints e terminologia genérica

## Requisitos Atendidos

- **REQ-406 a REQ-409:** Endpoints atualizados de `/lotes` para `/offers` conforme especificação
- **White Label:** Backend agora retorna terminologia genérica (`oferta`, `produto`) em vez de específica (`lote`, `resíduo`)
- **Compatibilidade Retroativa:** Mantidos aliases legados (`lotesVendidos`, `lotesComprados`, `lote_residuo`) para transição gradual

## Regras Aplicadas

- **Convenções de código:** Códigos de erro atualizados para refletir terminologia genérica
- **Testes:** Testes E2E atualizados para validar novos endpoints `/offers`
- **Documentação:** Comentários e mensagens de erro atualizados para terminologia genérica

## Mudanças Técnicas

### Códigos de Erro
- Adicionados `OWN_OFFER_PURCHASE` e `OFFER_ALREADY_SOLD` como códigos principais
- Mantidos `OWN_LOT_PURCHASE` e `LOT_ALREADY_SOLD` como aliases legados

### Queries SQL
- Atualizado `t.lote_residuo_id` para `t.offer_id` em todas as queries de transação
- Mantida compatibilidade com coluna `offer_id` no banco de dados

### Resposta de API
- Método `findByUserId` agora retorna `offersVendidos` e `offersComprados` como campos principais
- Mantidos `lotesVendidos` e `lotesComprados` como aliases legados

### Testes
- Todos os testes E2E atualizados para usar endpoints `/offers`
- Testes validam novos códigos de erro genéricos com fallback para legados
- Dados de teste atualizados para usar terminologia genérica (`Produto Premium`, `Produto Categoria B`, etc.)

## Pendências

- Validação final: Executar testes E2E completos após deploy
- Documentação: Atualizar documentação da API com novos endpoints `/offers`
- Migração gradual: Frontend já atualizado, backend mantém compatibilidade retroativa

## Referências RUP

- `docs/rup/02-planejamento/requisitos-spec.md` - REQ-406 a REQ-409
- `docs/rup/99-anexos/MVP/plano-white-label.md` - Plano de execução white label
- `docs/rup/99-anexos/reference/mapeamento-white-label.md` - Mapeamento de progresso

